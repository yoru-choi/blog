
<meta charset="utf-8">
<html lang="ko">
<head>
    <link rel="stylesheet" type="text/css" href="./../style.css" />
    <title>[ FCM ] Server에서 FCM 요청 보내기</title>
</head>
<body id="tt-body-page" class="">
<div id="wrap" class="wrap-right">
    <div id="container">
        <main class="main ">
            <div class="area-main">
                <div class="area-view">
                    <div class="article-header">
                        <div class="inner-article-header">
                            <div class="box-meta">
                                <h2 class="title-article">[ FCM ] Server에서 FCM 요청 보내기</h2>
                                <div class="box-info">
                                    <p class="category">ThirdParty/FCM</p>
                                    <p class="date">2023-07-26 11:09:32</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="article-view">
                        <div class="contents_style">
                            <h4 style="color: #000000; text-align: start;" data-ke-size="size20">Environment</h4>
<ul style="list-style-type: disc;" data-ke-list-type="disc">
<li>mac</li>
<li>node 18</li>
</ul>
<p data-ke-size="size16">&nbsp;</p>
<h3 style="color: #000000; text-align: start;" data-ke-size="size23">FCM이란</h3>
<p data-ke-size="size16">Firebase Cloud Messaging의 약어로, google에서 <b>어느 정도 무료</b>로 제공하는 <b>pushNotification service</b>다. 많이 쓰면 과금이다</p>
<p data-ke-size="size16">&nbsp;</p>
<p data-ke-size="size16">&nbsp;</p>
<h3 data-ke-size="size23">FCM 사용에 필요한 key 발급</h3>
<p style="color: #333333; text-align: start;" data-ke-size="size16"><span style="font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', 'Apple SD Gothic Neo', Arial, sans-serif; letter-spacing: 0px;"><b>앱 쪽 토큰</b>은 이미 발급돼 있다고 가정하자. </span><span style="font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', 'Apple SD Gothic Neo', Arial, sans-serif; letter-spacing: 0px;">프로젝트 설정에서 key를 찾으러 가야 한다</span></p>
<p style="color: #333333; text-align: start;" data-ke-size="size16"><span style="font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', 'Apple SD Gothic Neo', Arial, sans-serif; letter-spacing: 0px;">오른쪽 구석의<b> 계정권한관리</b> 버튼을 클릭하자</span></p>
<p><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img.png"  />
    </span>
    <figcaption></figcaption>
</figure></p>
<p data-ke-size="size16">&nbsp;</p>
<p data-ke-size="size16">아래의 화면처럼 넘어간다. 왼쪽 카테고리의 서비스 계정을 선택한다</p>
<p data-ke-size="size16">그리고 오른쪽에 보면 <b>키관리</b>가 있다. 이곳을 클릭해서 키추가를 하면 사용할<b> json 값</b>을 얻을 수 있다</p>
<p><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_1.png"  />
    </span>
    <figcaption></figcaption>
</figure></p>
<p data-ke-size="size16">&nbsp;</p>
<p data-ke-size="size16">&nbsp;</p>
<h3 data-ke-size="size23">backendSource작업</h3>
<p data-ke-size="size16">위에서 얻은 json파일에서<b> projectId, clientEmail, privateKey</b> 이렇게 3개를 사용한다</p>
<p data-ke-size="size16">env에 해당값들 정리해서 넣어준다. config에 따로 선언하고 호출해서 사용하면 된다</p>
<pre id="code_1687942258011" class="typescript" data-ke-language="typescript" data-ke-type="codeblock"><code>const fcm_config = {
  projectId: process.env.FCM_PROJECT_ID,
  clientEmail: process.env.FCM_CLIENT_EMAIL,
  privateKey: process.env.FCM_PRIVATE_KEY,
};</code></pre>
<p style="color: #333333; text-align: start;" data-ke-size="size16">&nbsp;</p>
<p style="color: #333333; text-align: start;" data-ke-size="size16">아래처럼 fcm을 보낼 api를 만들어주자. 잘 모르겠으면 <a href="https://firebase.google.com/docs/cloud-messaging/concept-options?hl=ko" target="_blank" rel="noopener">공식문서</a>를 참고하자</p>
<p data-ke-size="size16">아래와 같이 코드를 작성 후 testing 하면 token을 발급한 app을 가진 스마트폰에 <b>push notification이 전송</b>된다</p>
<p data-ke-size="size16">&nbsp;</p>
<pre id="code_1687942268812" class="typescript" data-ke-language="typescript" data-ke-type="codeblock"><code>import * as admin from 'firebase-admin'; //firebase 선언
import { fcmConfig } from '~v3/core/config/fcm'; //config invoke

   admin.initializeApp({
      credential: admin.credential.cert(fcm_config),
    });
    
    const fcm_message = admin
      .messaging()
      .send({
        token, //모바일 기기에서 발급한 token-&gt; 보내는곳
        // topic: '', // 전체 유저에게 보내고싶을때 사용
        apns: {
          headers: {
            'apns-push-type': 'alert',
            'apns-priority': '5',
          },
          payload: {
            aps: {
              alert: {
                title: 'iOS title',
                body: 'iOS body',
              },
              sound: 'default',
              contentAvailable: true, //data-only일경우 true로 해야 알림받기 가능
            },
          },
        },
        android: {
          priority: 'high', //data-only일경우 high로 해야 알림받기 가능
          notification: {
            title: 'Android title',
            body: 'Android body',
            channelId: 'test_test123', // 클라이언트에서 만든 채널
          },
        },
      })
      .then((data) =&gt; {
        return data;
      })
      .catch((err) =&gt; {
        console.error(err);
        throw new Error(err);
      });</code></pre>
<p style="color: #333333; text-align: start;" data-ke-size="size16">&nbsp;</p>
                        </div>
                        <br/>
                        <div class="tags">
                            #KR #FCM #Push Notification 
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
</body>
</html>
